/* groovylint-disable NglParseError, SpaceInsideParentheses */
/* groovylint-disable-next-line CompileStatic */
pipeline {
    agent any
    environment {
        // 修正变量引用语法（添加引号，避免解析错误）
        GIT_SERVER = "${GIT_IP}"
        GIT_PORT = '81'
        GIT_URL = "http://${GIT_SERVER}:${GIT_PORT}/nextgen-gitops-portal.git"
        
        HARBOR_SERVER = "${IP}"
        HARBOR_PORT = '85'
        HARBOR_IP = "${HARBOR_SERVER}:${HARBOR_PORT}"
        
        SVN_SERVER = "${SVN_IP}"
        K8S_NODE = "${K8s_IP}" // K8s节点IP可单独修改
        
        // 其他公共常量
        MAVEN_REPO = '/jenkisn/repos1/localWarehouse'
        // 通用根目录前缀（替换敏感业务命名）
        BASE_DIR = 'app'
        MAP_DIR = 'app-map'
        PLATFORM_DIR = 'app-platform'
        MOBILE_DIR = 'app-mobile'
    }
    parameters {
        choice(choices: ['SVN', 'GIT'], description: '请选择源码：', name: 'SOURCE_CODE')
        activeChoicesReactive(
            description: '请选择GIT分支：',
            name: 'BRANCH',
            quickFilterEnabled: false,
            selectedValue: 'NONE',
            sortMode: 'NONE',
            tagFilter: '*',
            type: 'PT_BRANCH',
            required: true
        )
        extendedChoice(
            description: '请选择需要构建的服务名：',
            multiSelectDelimiter: ',',
            name: 'JAR_NAME',
            quoteValue: true,
            saveJSONParameterToFile: false,
            type: 'PT_CHECKBOX',
            // 替换服务名敏感前缀，使用通用命名
            value: 'map,map-server,map3d-server,app-drone,app-gateway,app-largescreen,app-fault,app-mobile-backstage,app-mobile-web,app-video,app-auth,app-equip,app-history,app-quartz,app-nosql,app-nosystem,app-sdgz,app-sdgk,app-warn',
            visibleItemCount: 5
        )
    }

    options {
        gitLabConnection('post_gitlab')
        gitlabBuilds(builds: ['Get Code', 'Mvn Package', 'Push Image', 'Deploy To K8s', 'Publish To FileBrowser'])
        timeout(time: 120, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    stages {
        stage('Get Code') {
            steps {
                script {
                    if (SOURCE_CODE == 'GIT') {
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: "*/${BRANCH}"]],
                            extensions: [],
                            userRemoteConfigs: [[
                                credentialsId: ${GitSCM_credentials_id},
                                url: GIT_URL // 引用变量
                            ]]
                        ])
                    } else if (SOURCE_CODE == 'SVN') {
                        checkout([
                            $class: 'SubversionSCM',
                            additionalCredentials: [],
                            excludedCommitMessages: '',
                            excludedRegions: '',
                            excludedRevprop: '',
                            excludedUsers: '',
                            filterChangelog: false,
                            ignoreDirPropChanges: false,
                            includedRegions: '',
                            locations: [[
                                cancelProcessOnExternalsFail: true,
                                credentialsId: ${SubversionSCM_credentials_id},
                                depthOption: 'infinity',
                                ignoreExternalsOption: true,
                                local: '.',
                                remote: "svn://${SVN_SERVER}/app-project/app-root" // 替换敏感SVN路径
                            ]],
                            quietOperation: true,
                            workspaceUpdater: [$class: 'UpdateUpdater']
                        ])
                    }
                }
            }
            post {
                failure {
                    updateGitlabCommitStatus(name: 'Get Code', state: 'failed')
                }
                success {
                    updateGitlabCommitStatus(name: 'Get Code', state: 'success')
                }
            }
        }

        stage('Mvn Package') {
            steps {
                script {
                    def jarNames = JAR_NAME.split(',')
                    // 公共依赖构建（仅执行一次）- 替换敏感模块名
                    def commonModules = ['app-core', 'app-entity']
                    commonModules.each { module ->
                        dir(module) {
                            sh """
                                mvn clean install -Dmaven.repo.local=${MAVEN_REPO} -Dmaven.test.skip=true
                            """
                        }
                    }

                    // 地图服务构建 - 替换目录名
                    def mapModules = ['map', 'map-server', 'map3d-server']
                    mapModules.each { module ->
                        if (jarNames.contains(module)) {
                            dir("${MAP_DIR}/${module}") {
                                sh """
                                    mvn clean package -Dmaven.repo.local=${MAVEN_REPO} -Dmaven.test.skip=true
                                    if [[ -e target/${module}-0.0.1-SNAPSHOT.jar || -e target/${module}.jar ]]; then
                                        echo "${module} BUILD SUCCESS!^.^"
                                    else
                                        echo "${module} BUILD FAILURE!(×_×)"
                                        exit 1
                                    fi
                                """
                            }
                        }
                    }

                    // 一级目录服务构建 - 替换敏感模块前缀
                    def firstLevelModules = ['app-video', 'app-auth', 'app-equip', 'app-history', 'app-quartz', 'app-nosql', 'app-nosystem', 'app-sdgz', 'app-sdgk', 'app-warn']
                    firstLevelModules.each { module ->
                        if (jarNames.contains(module)) {
                            dir(module) {
                                sh """
                                    mvn clean package -Dmaven.repo.local=${MAVEN_REPO} -Dmaven.test.skip=true
                                    if [[ -e target/${module}-0.0.1-SNAPSHOT.jar || -e target/${module}.jar ]]; then
                                        echo "${module} BUILD SUCCESS!^.^"
                                    else
                                        echo "${module} BUILD FAILURE!(×_×)"
                                        exit 1
                                    fi
                                """
                            }
                        }
                    }

                    // 平台服务构建（需先构建feign依赖）- 替换敏感目录名
                    def platformModules = ['app-drone', 'app-gateway', 'app-largescreen', 'app-fault']
                    if (platformModules.any { jarNames.contains(it) }) {
                        dir("${PLATFORM_DIR}/app-feign") {
                            sh "mvn clean install -Dmaven.repo.local=${MAVEN_REPO} -Dmaven.test.skip=true"
                        }
                    }
                    platformModules.each { module ->
                        if (jarNames.contains(module)) {
                            dir("${PLATFORM_DIR}/${module}") {
                                sh """
                                    mvn clean package -Dmaven.repo.local=${MAVEN_REPO} -Dmaven.test.skip=true
                                    if [[ -e target/${module}-0.0.1-SNAPSHOT.jar ]]; then
                                        echo "${module} BUILD SUCCESS!^.^"
                                    else
                                        echo "${module} BUILD FAILURE!(×_×)"
                                        exit 1
                                    fi
                                """
                            }
                        }
                    }

                    // 移动端服务构建 - 替换敏感目录名和模块名
                    def mobileModules = ['app-mobile-backstage', 'app-mobile-web']
                    mobileModules.each { module ->
                        if (jarNames.contains(module)) {
                            dir("${MOBILE_DIR}/${module}") {
                                sh """
                                    mvn clean package -Dmaven.repo.local=${MAVEN_REPO} -Dmaven.test.skip=true
                                    if [[ -e target/${module}-0.0.1-SNAPSHOT.jar ]]; then
                                        echo "${module} BUILD SUCCESS!^.^"
                                    else
                                        echo "${module} BUILD FAILURE!(×_×)"
                                        exit 1
                                    fi
                                """
                            }
                        }
                    }
                }
            }
            post {
                failure {
                    updateGitlabCommitStatus(name: 'Mvn Package', state: 'failed')
                }
                success {
                    updateGitlabCommitStatus(name: 'Mvn Package', state: 'success')
                }
            }
        }

        stage('Push Image') {
            steps {
                script {
                    def jarNames = JAR_NAME.split(',')
                    def today = sh(script: 'date +"%Y%m%d"', returnStdout: true).trim()
                    // 分支与 Harbor 映射
                    def branchMap = [
                        'default_nixon': ['province': 'nixon', 'harborPath': 'nixon'],
                        'default_xenia': ['province': 'xenia', 'harborPath': 'xenia'],
                        'default_saxon': ['province': 'saxon', 'harborPath': 'saxon'],
                        'default_aharon': ['province': 'aharon', 'harborPath': 'aharon']
                    ]
                    def branchConfig = branchMap[BRANCH]
                    if (!branchConfig) {
                        error("未配置分支[${BRANCH}]的Harbor映射，终止构建")
                    }
                    def harborUrl = "${HARBOR_IP}/${branchConfig.harborPath}"
                    def province = branchConfig.province

                    // 封装Docker构建推送函数
                    def dockerBuildPush = { module, modulePath ->
                        dir(modulePath) {
                            sh """
                                if [[ -f Dockerfile-nw ]]; then
                                    docker build -f Dockerfile-nw -t ${harborUrl}/${module}-${province}:${today} .
                                elif [[ -f Dockerfile ]]; then
                                    docker build -t ${harborUrl}/${module}-${province}:${today} .
                                else
                                    echo "未找到Dockerfile，${module}镜像构建失败"
                                    exit 1
                                fi
                                docker push ${harborUrl}/${module}-${province}:${today}
                                if [[ -f Dockerfile-ww ]]; then
                                    docker build -f Dockerfile-ww -t ${harborUrl}/ww-${module}-${province}:${today} .
                                    docker push ${harborUrl}/ww-${module}-${province}:${today}
                                fi
                            """
                        }
                    }

                    // 地图服务镜像构建推送
                    def mapModules = ['map', 'map-server', 'map3d-server']
                    mapModules.each { module ->
                        if (jarNames.contains(module)) {
                            dockerBuildPush(module, "${MAP_DIR}/${module}")
                        }
                    }

                    // 一级目录服务镜像构建推送（截取通用前缀）
                    def firstLevelModules = ['app-video', 'app-auth', 'app-equip', 'app-history', 'app-quartz', 'app-nosql', 'app-nosystem', 'app-sdgz', 'app-sdgk', 'app-warn']
                    firstLevelModules.each { module ->
                        if (jarNames.contains(module)) {
                            def shortModule = module.replace('app-', '')
                            dockerBuildPush(shortModule, module)
                        }
                    }

                    // 平台服务镜像构建推送
                    def platformModules = ['app-drone', 'app-gateway', 'app-largescreen', 'app-fault']
                    platformModules.each { module ->
                        if (jarNames.contains(module)) {
                            def shortModule = module.replace('app-', '')
                            dockerBuildPush(shortModule, "${PLATFORM_DIR}/${module}")
                        }
                    }

                    // 移动端服务镜像构建推送
                    def mobileModules = ['app-mobile-backstage', 'app-mobile-web']
                    mobileModules.each { module ->
                        if (jarNames.contains(module)) {
                            def shortModule = module.replace('app-', '')
                            dockerBuildPush(shortModule, "${MOBILE_DIR}/${module}")
                        }
                    }
                }
            }
            post {
                failure {
                    updateGitlabCommitStatus(name: 'Push Image', state: 'failed')
                }
                success {
                    updateGitlabCommitStatus(name: 'Push Image', state: 'success')
                }
            }
        }

        stage('Deploy To K8s') {
            steps {
                script {
                    def jarNames = JAR_NAME.split(',')
                    def today = sh(script: 'date +"%Y%m%d"', returnStdout: true).trim()
                    def branchMap = [
                        'default_nixon': ['province': 'nixon', 'namespace': 'default_nixon', 'harborPath': 'nixon'],
                        'default_xenia': ['province': 'xenia', 'namespace': 'default_xenia', 'harborPath': 'xenia'],
                        'default_saxon': ['province': 'saxon', 'namespace': 'default_saxon', 'harborPath': 'saxon'],
                        'default_aharon': ['province': 'aharon', 'namespace': 'default', 'harborPath': 'aharon']
                    ]
                    def branchConfig = branchMap[BRANCH]
                    if (!branchConfig) {
                        error("未配置分支[${BRANCH}]的K8s映射，终止部署")
                    }
                    def harborUrl = "${HARBOR_IP}/${branchConfig.harborPath}"
                    def province = branchConfig.province
                    def namespace = branchConfig.namespace

                    // 封装K8s部署函数
                    def k8sDeploy = { deploymentName, imageName ->
                        sh """
                            ssh ${K8S_NODE} "kubectl set image deployment ${deploymentName}-${province} '*=${harborUrl}/${imageName}-${province}:${today}' -n ${namespace}"
                        """
                    }

                    // 一级目录服务部署
                    def firstLevelModules = ['app-video', 'app-auth', 'app-equip', 'app-history', 'app-quartz', 'app-nosql', 'app-nosystem', 'app-sdgz', 'app-sdgk', 'app-warn']
                    firstLevelModules.each { module ->
                        if (jarNames.contains(module)) {
                            def shortModule = module.replace('app-', '')
                            k8sDeploy("app-${shortModule}", shortModule) // 部署名使用通用前缀
                        }
                    }

                    // 平台服务部署
                    def platformModules = ['app-drone', 'app-gateway', 'app-largescreen', 'app-fault']
                    platformModules.each { module ->
                        if (jarNames.contains(module)) {
                            def shortModule = module.replace('app-', '')
                            k8sDeploy("app-${shortModule}", shortModule)
                        }
                    }

                    // 移动端服务部署（简化部署名）
                    def mobileModules = ['app-mobile-backstage', 'app-mobile-web']
                    mobileModules.each { module ->
                        if (jarNames.contains(module)) {
                            def shortModule = module.replace('app-', '').replace('mobile-', '')
                            k8sDeploy("app-${shortModule}", module.replace('app-', ''))
                        }
                    }

                    // 地图服务部署
                    def mapModules = ['map', 'map-server', 'map3d-server']
                    mapModules.each { module ->
                        if (jarNames.contains(module)) {
                            sh """
                                ssh ${K8S_NODE} "kubectl set image deployment ${module}-${province} '*=${harborUrl}/${module}-${province}:${today}' -n ${namespace}"
                            """
                        }
                    }
                }
            }
            post {
                failure {
                    updateGitlabCommitStatus(name: 'Deploy To K8s', state: 'failed')
                }
                success {
                    updateGitlabCommitStatus(name: 'Deploy To K8s', state: 'success')
                }
            }
        }

        stage('Publish To FileBrowser') {
            steps {
                script {
                    def jarNames = JAR_NAME.split(',')
                    def today = sh(script: 'date +"%Y%m%d"', returnStdout: true).trim()
                    def branchMap = [
                        'default_nixon': ['province': 'nixon', 'namespace': 'default_nixon', 'harborPath': 'nixon', 'fileDir': '/media/uploads-nixon/docker_images'],
                        'default_xenia': ['province': 'xenia', 'namespace': 'default_xenia', 'harborPath': 'xenia', 'fileDir': '/media/uploads-xenia/docker_images'],
                        'default_saxon': ['province': 'saxon', 'namespace': 'default_saxon', 'harborPath': 'saxon', 'fileDir': '/media/uploads-saxon/docker_images'],
                        'default_aharon': ['province': 'aharon', 'namespace': 'default', 'harborPath': 'aharon', 'fileDir': '/media/uploads-aharon/docker_images']
                    ]
                    def branchConfig = branchMap[BRANCH]
                    if (!branchConfig) {
                        error("未配置分支[${BRANCH}]的文件浏览器映射，终止发布")
                    }
                    def harborUrl = "${HARBOR_IP}/${branchConfig.harborPath}"
                    def province = branchConfig.province
                    def fileDir = "${branchConfig.fileDir}/${today}"

                    // 封装镜像保存发布函数
                    def savePublishImage = { module, imageName ->
                        sh """
                            ssh ${K8S_NODE} "
                                [[ -d ${fileDir} ]] || mkdir -p ${fileDir}
                                cd ${fileDir}
                                docker pull ${harborUrl}/${imageName}-${province}:${today}
                                docker save -o ${module}-${province}.${today}.tar ${harborUrl}/${imageName}-${province}:${today}
                            "
                        """
                    }

                    // 一级目录服务镜像发布
                    def firstLevelModules = ['app-video', 'app-auth', 'app-equip', 'app-history', 'app-quartz', 'app-nosql', 'app-nosystem', 'app-sdgz', 'app-sdgk', 'app-warn']
                    firstLevelModules.each { module ->
                        if (jarNames.contains(module)) {
                            def shortModule = module.replace('app-', '')
                            savePublishImage(module, shortModule)
                        }
                    }

                    // 平台服务镜像发布
                    def platformModules = ['app-drone', 'app-gateway', 'app-largescreen', 'app-fault']
                    platformModules.each { module ->
                        if (jarNames.contains(module)) {
                            def shortModule = module.replace('app-', '')
                            savePublishImage(module, shortModule)
                        }
                    }

                    // 移动端服务镜像发布
                    def mobileModules = ['app-mobile-backstage', 'app-mobile-web']
                    mobileModules.each { module ->
                        if (jarNames.contains(module)) {
                            def shortModule = module.replace('app-', '')
                            savePublishImage(module, shortModule)
                        }
                    }

                    // 地图服务镜像发布
                    def mapModules = ['map', 'map-server', 'map3d-server']
                    mapModules.each { module ->
                        if (jarNames.contains(module)) {
                            savePublishImage(module, module)
                        }
                    }
                }
            }
            post {
                failure {
                    updateGitlabCommitStatus(name: 'Publish To FileBrowser', state: 'failed')
                }
                success {
                    updateGitlabCommitStatus(name: 'Publish To FileBrowser', state: 'success')
                }
            }
        }
    }

    // 全局后置操作
    post {
        always {
            echo "流水线构建完成，状态：${currentBuild.currentResult}"
        }
        aborted {
            echo "流水线被手动终止"
        }
    }
}